$ErrorActionPreference = "Stop";
trap { $host.SetShouldExit(1) }

function EchoWithDate {
  Param (
    [string] $msg
  )
  $date = Get-Date -Format "dd-MM-yyyy @ hh:mm:ss"
  Write-Host "$date - $msg"
}

EchoWithDate "Begin winc-network-hns-acls pre-start"

EchoWithDate "Start http service"
Start-Service -Name http
EchoWithDate "Started http service"

EchoWithDate "winc-network-hns-acls delete"
$deleteLog = New-TemporaryFile
C:\var\vcap\packages\winc-network-hns-acls\winc-network.exe --log $deleteLog.Name --debug --log-format json --action delete --configFile C:\var\vcap\jobs\winc-network-hns-acls\config\interface.json
if ($LASTEXITCODE -ne 0) {
  $file = (Get-Content $deleteLog.Name)
  EchoWithDate $file
  Remove-Item -Force -Path $deleteLog.Name
  exit $LASTEXITCODE
}
Remove-Item -Force -Path $deleteLog.Name

EchoWithDate "winc-network-hns-acls create"
$createLog = New-TemporaryFile
C:\var\vcap\packages\winc-network-hns-acls\winc-network.exe --log $createLog.Name --debug --log-format json --action create --configFile C:\var\vcap\jobs\winc-network-hns-acls\config\interface.json
if ($LASTEXITCODE -ne 0) {
  $file = (Get-Content $createLog.Name)
  EchoWithDate $file
  Remove-Item -Force -Path $createLog.Name
  exit $LASTEXITCODE
}
Remove-Item -Force -Path $createLog

EchoWithDate "Blocking Inbound and Allowing Outbound connections"
Set-NetFirewallProfile -All -DefaultInboundAction Block -DefaultOutboundAction Allow -Enabled True
EchoWithDate "Blocked Inbound and Allowed Outbound connections"

EchoWithDate "Finished winc-network-hns-acls pre-start"
Exit 0
